<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mood ‚Üí Workout Recommender ‚Äî Nadim Sheikh</title>
  <meta name="description" content="Psychology-informed Mood‚ÜíWorkout recommender. Static demo ‚Äî no backend.">
  <style>
    :root{
      --bg-1:#041022; --bg-2:#07162a; --muted:#9bb0c3;
      --accent-1:#67e6ff; --accent-2:#3ad6c9;
      --mood-color:#67e6ff; --stress-color:#ff9f6b; --sleep-color:#9be67a;
      --card-radius:12px; --shadow: 0 14px 36px rgba(2,10,20,0.6);
      font-family: Inter, "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
    }

    /* Page (prevent page scroll; internal card scroll only) */
    html,body{height:100%;margin:0;overflow:hidden;
      background:
        radial-gradient(900px 400px at 8% 8%, rgba(12,40,70,0.12), transparent 8%),
        linear-gradient(180deg,var(--bg-1), var(--bg-2));
      color:#eaf8ff;-webkit-font-smoothing:antialiased;}

    .app{height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;}
    .panel{width:100%;max-width:980px;height:calc(100vh - 40px);display:grid;grid-template-rows:auto 1fr;gap:12px;position:relative;}

    header{padding:6px 10px}
    h1{margin:0;font-size:20px}
    p.lead{margin:6px 0 0 0;color:var(--muted);font-size:13px}

    /* Main card */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: 14px; padding:16px; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,0.03);
      display:flex; flex-direction:column; gap:12px; overflow:auto;
    }

    /* Inputs */
    .inputs{display:grid;grid-template-columns: 1fr 1fr;gap:14px}
    label{display:block;color:var(--muted);font-size:13px;margin-bottom:8px}
    .slider-wrap{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); padding:10px;border-radius:10px}
    input[type="range"]{width:100%; accent-color: var(--accent-1)}

    .controls{display:flex;gap:10px;align-items:center}
    .btn{background:linear-gradient(180deg,var(--accent-1), #39d7e3); border:none; color:#042026; padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer; box-shadow:0 8px 20px rgba(15,113,131,0.08);}
    .btn.secondary{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03);font-weight:700;padding:9px 12px}
    .btn:focus{outline:2px solid rgba(103,230,255,0.12)}

    /* Result */
    .result{border-radius:12px;padding:14px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border-left:4px solid rgba(103,230,255,0.06);font-size:14px}
    .result h3{margin:0 0 8px 0;font-size:16px}
    .result p{margin:0;color:#eaf8ff;white-space:pre-wrap}
    .result ul{margin:8px 0 0 18px;color:var(--muted)}
    .meta{margin-top:10px;color:var(--muted);font-size:13px}

    /* Consent */
    .consent{display:none;margin-top:8px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
    .consent.show{display:block}

    /* Chart & history */
    .history{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:6px}
    .chart{width:420px;height:120px;border-radius:8px;display:flex;align-items:center;justify-content:center}
    .no-history{color:var(--muted);font-size:13px}

    .legend{display:flex;gap:10px;align-items:center}
    .legend-item{display:flex;gap:6px;align-items:center;color:var(--muted);font-size:12px}
    .legend-dot{width:10px;height:10px;border-radius:999px}

    /* Safety box on left (outside card area) */
    .safety-box{
      position:absolute;
      left:-220px; /* tweak to place in left highlighted area */
      top:40px;
      width:200px;
      min-height:120px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03);
      padding:12px;
      box-shadow:0 14px 36px rgba(2,10,20,0.5);
      display:none;
      box-sizing:border-box;
    }
    .safety-box.show{display:block}
    .safety-box .title{display:flex;align-items:center;gap:8px;font-weight:700;color:#ffece8;margin-bottom:8px}
    .safety-box .text{color:var(--muted);font-size:13px;line-height:1.2}

    /* Built by inside card bottom */
    .built{color:var(--muted);font-size:13px;padding-top:6px}

    /* Tooltip for chart */
    .chart-tooltip{
      position:absolute;
      pointer-events:none;
      background:rgba(2,10,20,0.9);
      color:#fff;
      padding:6px 8px;
      border-radius:6px;
      font-size:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.5);
      transform:translate(-50%,-120%);
      white-space:nowrap;
      display:none;
      z-index:10;
    }

    @media (max-width:980px){
      .safety-box{display:none}
      .inputs{grid-template-columns:1fr}
      .chart{width:100%;height:100px}
    }
  </style>
</head>
<body>
  <main class="app" role="main">
    <div class="panel" id="panel">
      <header>
        <h1 id="appTitle">Mood ‚Üí Workout Recommender</h1>
        <p class="lead">Psychology-informed quick recommendations using simple, explainable rules. Static demo ‚Äî no backend.</p>
      </header>

      <!-- safety box (left of card) -->
      <div id="safetyBox" class="safety-box" role="status" aria-live="polite" aria-hidden="true">
        <div class="title">‚ö†Ô∏è Safety first</div>
        <div id="safetyText" class="text">You reported extremely low sleep, very high stress, or very low mood. Prioritize rest and safety ‚Äî avoid intense exercise now. If at risk, contact emergency services.</div>
      </div>

      <!-- main card -->
      <section class="card" aria-labelledby="appTitle">
        <div class="inputs" aria-hidden="false">
          <div>
            <label for="mood">Mood (0 sad ‚Äî 10 happy): <strong id="moodVal">0</strong></label>
            <div class="slider-wrap"><input id="mood" type="range" min="0" max="10" value="0" /></div>
          </div>

          <div>
            <label for="stress">Stress (0 low ‚Äî 10 high): <strong id="stressVal">0</strong></label>
            <div class="slider-wrap"><input id="stress" type="range" min="0" max="10" value="0" /></div>
          </div>

          <div style="grid-column:1 / -1;">
            <label for="sleep">Sleep last night (hours / 10): <strong id="sleepVal">0</strong></label>
            <div class="slider-wrap"><input id="sleep" type="range" min="0" max="10" value="0" /></div>
          </div>

          <div style="grid-column:1 / -1; display:flex; gap:10px; align-items:center;">
            <button id="go" class="btn">Get Recommendation</button>
            <button id="sample" class="btn secondary">Try sample</button>
            <button id="reset" class="btn secondary">Reset</button>
          </div>
        </div>

        <div id="result" class="result" style="display:none" aria-live="polite"></div>

        <div id="consentBox" class="consent" role="group" aria-label="consent area">
          <label style="display:flex;align-items:center;gap:8px">
            <input id="consentCheck" type="checkbox" />
            <span style="color:var(--muted)">I understand this is a safety-first recovery plan. I give consent to see optional gentle movement suggestions (only if I feel safe).</span>
          </label>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="consentProceed" class="btn" disabled>Show suggestions</button>
            <button id="consentSkip" class="btn secondary">Skip suggestions</button>
          </div>
        </div>

        <div class="history" aria-label="Recent submissions">
          <div>
            <div style="color:var(--muted);font-size:13px;margin-bottom:8px">Recent submissions (last 5)</div>
            <button id="clearHistory" class="btn secondary" style="font-size:13px;padding:8px 10px">Clear history</button>
          </div>

          <div>
            <div class="legend" style="margin-bottom:6px">
              <div class="legend-item"><span class="legend-dot" style="background:var(--mood-color)"></span>Mood</div>
              <div class="legend-item"><span class="legend-dot" style="background:var(--stress-color)"></span>Stress</div>
              <div class="legend-item"><span class="legend-dot" style="background:var(--sleep-color)"></span>Sleep</div>
            </div>
            <div id="chartContainer" class="chart" role="img" aria-label="history chart" style="position:relative">
              <div class="no-history">No history yet ‚Äî submit to record.</div>
              <div id="chartTooltip" class="chart-tooltip" role="tooltip"></div>
            </div>
          </div>
        </div>

        <div class="built">Built by <strong>Nadim Sheikh</strong></div>
      </section>

    </div>
  </main>

  <script>
    /* ----------------- suggestions and UI are same as before ---------------
       For brevity the SUGGESTIONS and decision logic are included compactly.
       (They match the 10 recommendations you confirmed earlier.)
    */
    const SUGGESTIONS = {/* full SUGGESTIONS object: omitted here for brevity in comments */};

    // (We'll reuse the SUGGESTIONS from your previous implementation.)
    // To avoid errors, re-declare the full object inline (same as prior).
    // For the purpose of this paste, I'll create it programmatically below:
    (function populateSuggestions() {
      window.APP_SUGGESTIONS = {
        immediate_recovery: { title:"üõå Immediate Recovery ‚Äî Rest First", description:"Priority: safety and rest. Breathe, hydrate, eat a light snack, rest. Avoid intense exercise until you have restorative sleep.", steps:["Sit or lie down in a safe, comfortable place.","3‚Äì6 min diaphragmatic breathing (4s inhale ‚Äî 6s exhale).","Drink ~200‚Äì300 ml water slowly.","If possible, eat a light snack (banana, yoghurt, or toast).","Ask a trusted person for a 20‚Äì30 min check-in."], intensity:"Very low" },
        grounding_stress: { title:"üßò Grounding + Gentle Movement", description:"Start with grounding breathing for 3‚Äì5 minutes, then light movement (standing mobility or a short walk) to reduce physiological arousal.", steps:["3‚Äì5 min grounding breathing","5‚Äì7 min gentle walk/standing mobility","2 min progressive muscle relaxation"], intensity:"Very low" },
        mood_activation: { title:"üèÉ Short Cardio Burst (Mood Booster)", description:"Moderate cardio for mood boost. If energy is low, use the 10‚Äì12 minute option.", steps:["5 min warm-up","12‚Äì20 min moderate cardio (or 10‚Äì12 min if low energy)","3‚Äì5 min cool down + breathing"], intensity:"Moderate" },
        balanced: { title:"‚öñÔ∏è Balanced Session", description:"30-minute balanced routine: warm-up, focused work, cool-down. Useful as daily default and for tracking responses.", steps:["8 min warm-up (mobility + light cardio)","15 min focused work (cardio or strength)","7 min cool-down + breathing"], intensity:"Moderate" },
        restorative_yoga: { title:"üßò‚Äç‚ôÄÔ∏è Restorative Yoga Flow (Deep Recovery)", description:"10‚Äì12 minutes of restorative yoga poses plus prolonged exhalations to support deep recovery and vagal activation.", steps:["10‚Äì12 min restorative poses (legs-up, reclined twist, child pose)","Long exhales and diaphragmatic breathing","Savasana or quiet rest"], intensity:"Very low" },
        mobility_reset: { title:"üåÄ Mobility Reset (Joint care)", description:"8‚Äì10 minutes of targeted mobility for shoulders, hips, and spine ‚Äî useful midday or after long sitting.", steps:["Neck and shoulder mobility (2‚Äì3 min)","Hip and ankle mobility (3‚Äì4 min)","Spine rotations + gentle breaths (2‚Äì3 min)"], intensity:"Low" },
        strength_micro: { title:"üí™ Strength Micro-Session", description:"12‚Äì15 minute high-effort micro strength circuit: short sets, brief rests ‚Äî builds confidence and perceived control.", steps:["3 rounds of: 40s work / 20s rest","Movements: squats, push-ups, single-leg hinge, plank variations","3‚Äì5 min mobility + breathing"], intensity:"Moderate" },
        walking_meditation: { title:"üö∂ Walking Meditation (Anxiety Relief)", description:"10‚Äì20 minutes slow mindful walking focusing on breath and sensory grounding to reduce anxiety and cognitive overload.", steps:["3 min centring breath","10‚Äì20 min mindful slow walk","2‚Äì3 min grounding breathing after walk"], intensity:"Low" },
        high_energy_cardio: { title:"‚ö° High-Energy Cardio Blast", description:"Interval or sustained faster cardio for 10‚Äì20 minutes. Best on high-energy days with good sleep.", steps:["5 min warm-up","10‚Äì15 min higher-intensity cardio or intervals","5 min cool-down + breathing"], intensity:"High" },
        cognitive_reset: { title:"üß† Cognitive Reset (Mental Overload Fix)", description:"A low-intensity reset for mental fatigue: brief breathing, a short walk, and gentle stretching to reorient focus.", steps:["3 min breathing","5‚Äì7 min slow walk or pacing","4‚Äì5 min light stretching"], intensity:"Very low" }
      };
    })();

    // DOM refs
    const mood = document.getElementById('mood');
    const stress = document.getElementById('stress');
    const sleep = document.getElementById('sleep');
    const moodVal = document.getElementById('moodVal');
    const stressVal = document.getElementById('stressVal');
    const sleepVal = document.getElementById('sleepVal');
    const go = document.getElementById('go');
    const sample = document.getElementById('sample');
    const reset = document.getElementById('reset');
    const result = document.getElementById('result');
    const safetyBox = document.getElementById('safetyBox');
    const consentBox = document.getElementById('consentBox');
    const consentCheck = document.getElementById('consentCheck');
    const consentProceed = document.getElementById('consentProceed');
    const consentSkip = document.getElementById('consentSkip');
    const chartContainer = document.getElementById('chartContainer');
    const chartTooltip = document.getElementById('chartTooltip');
    const clearHistory = document.getElementById('clearHistory');

    function updateLabels(){
      moodVal.textContent = mood.value;
      stressVal.textContent = stress.value;
      sleepVal.textContent = sleep.value;
    }
    [mood,stress,sleep].forEach(el => el.addEventListener('input', updateLabels));
    updateLabels();

    // local history (last 5)
    const STORAGE_KEY = 'mwr_history_v1';
    function loadHistory(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):[] }catch(e){return []} }
    function saveHistory(arr){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr.slice(-5))); }catch(e){} }
    function pushRecord(rec){ const arr = loadHistory(); arr.push(rec); const slice = arr.slice(-5); saveHistory(slice); return slice; }
    clearHistory.addEventListener('click', () => { localStorage.removeItem(STORAGE_KEY); renderChart([]); });

    // decision logic (same mapping you approved)
    function decideRecommendation(m,s,sl){
      if (sl <= 1 && s >= 9 && m <= 3) return { primary:'immediate_recovery' };
      if (sl <= 2) return { primary:'immediate_recovery' };
      if (s >= 9) return m <=4 ? { primary:'grounding_stress' } : { primary:'grounding_stress' };
      if (s >= 8) return m <=5 ? { primary:'walking_meditation' } : { primary:'grounding_stress' };
      if (m <=4) return sl >=5 ? { primary:'mood_activation' } : (s <=4 ? { primary:'restorative_yoga' } : { primary:'cognitive_reset' });
      if (sl <=4 && s <=5 && m >=4) return { primary:'restorative_yoga' };
      if (m >=5 && s >=4 && s <=7 && sl >=3 && sl <=7) return { primary:'mobility_reset' };
      if (m >=8 && s <=4 && sl >=6) return { primary:'high_energy_cardio' };
      if (m >=6 && sl >=5 && s <=6) return { primary:'strength_micro' };
      if (s >=6 && m >=4 && sl >=3 && sl <=6) return { primary:'cognitive_reset' };
      return { primary:'balanced' };
    }

    // render recommendation & safety
    function renderRecommendation(decision,reported){
      const key = decision.primary;
      const primary = window.APP_SUGGESTIONS[key];
      const isSafety = key === 'immediate_recovery';
      if (isSafety && safetyBox){ safetyBox.classList.add('show'); }
      else if (safetyBox) safetyBox.classList.remove('show');

      if (result){
        const stepsHtml = primary.steps && primary.steps.length ? `<ul>${primary.steps.map(s => `<li>${s}</li>`).join('')}</ul>` : '';
        result.style.display = 'block';
        result.innerHTML = `<h3>${primary.title}</h3><p style="margin-top:8px">${primary.description}</p>${stepsHtml}<div class="meta">You reported mood ${reported.m}, stress ${reported.s}, sleep ${reported.sl}. Suggested intensity: ${primary.intensity}.</div>`;
      }

      if (isSafety && consentBox){ consentBox.classList.add('show'); consentCheck.checked=false; consentProceed.disabled=true; }
      else if (consentBox){ consentBox.classList.remove('show'); }
    }

    /* ----------------- NEW: improved chart rendering -----------------
       - Smooth curves using Catmull-Rom -> Cubic B√©zier conversion
       - Gridlines, y-axis ticks, legend, small point markers
       - Hover tooltip showing time + value
    ------------------------------------------------------------------*/

    // helper: convert Catmull-Rom points to cubic B√©zier path (returns "d" string)
    // pts: array of {x,y}. tension optional (0.5 typical)
    function catmullRom2bezier(pts, tension = 0.5) {
      if (!pts || pts.length === 0) return '';
      if (pts.length === 1) return `M ${pts[0].x} ${pts[0].y}`;
      let d = `M ${pts[0].x} ${pts[0].y}`;
      for (let i = 0; i < pts.length - 1; i++) {
        const p0 = pts[i - 1] || pts[i];
        const p1 = pts[i];
        const p2 = pts[i + 1];
        const p3 = pts[i + 2] || p2;

        const t = tension;

        const cp1x = p1.x + (p2.x - p0.x) / 6 * t;
        const cp1y = p1.y + (p2.y - p0.y) / 6 * t;

        const cp2x = p2.x - (p3.x - p1.x) / 6 * t;
        const cp2y = p2.y - (p3.y - p1.y) / 6 * t;

        d += ` C ${cp1x.toFixed(2)} ${cp1y.toFixed(2)}, ${cp2x.toFixed(2)} ${cp2y.toFixed(2)}, ${p2.x.toFixed(2)} ${p2.y.toFixed(2)}`;
      }
      return d;
    }

    // draw chart given history array (last up to 5 records)
    function renderChart(history){
      chartContainer.innerHTML = '';
      chartTooltip.style.display = 'none';
      if (!history || history.length === 0) {
        chartContainer.innerHTML = '<div class="no-history">No history yet ‚Äî submit to record.</div>';
        return;
      }

      // prepare svg surface
      const w = chartContainer.clientWidth || 420;
      const h = chartContainer.clientHeight || 120;
      const padding = { l: 30, r: 8, t: 10, b: 22 };
      const innerW = Math.max(80, w - padding.l - padding.r);
      const innerH = Math.max(40, h - padding.t - padding.b);

      // x scale: n points
      const n = history.length;
      const xStep = n === 1 ? 0 : innerW / (n - 1);
      const x = i => padding.l + i * xStep;

      // y scale: 0..10 => map to padding.t..padding.t+innerH
      const y = v => padding.t + innerH - (v / 10) * innerH;

      // points arrays
      const moodPts = history.map((d, i) => ({ x: x(i), y: y(d.m), v: d.m, t: d.t }));
      const stressPts = history.map((d, i) => ({ x: x(i), y: y(d.s), v: d.s, t: d.t }));
      const sleepPts = history.map((d, i) => ({ x: x(i), y: y(d.sl), v: d.sl, t: d.t }));

      // grid lines and y ticks
      const yTicks = [10, 5, 0];

      // build svg content
      let svg = `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="history chart">`;

      // background subtle
      svg += `<rect x="0" y="0" width="${w}" height="${h}" fill="none"/>`;

      // grid lines
      yTicks.forEach(t => {
        const yy = y(t);
        svg += `<line x1="${padding.l}" x2="${w - padding.r}" y1="${yy}" y2="${yy}" stroke="rgba(255,255,255,0.03)" stroke-width="1"/>`;
        svg += `<text x="${8}" y="${yy+4}" fill="${getComputedStyle(document.documentElement).getPropertyValue('--muted')}" font-size="11">${t}</text>`;
      });

      // helper to create path
      const moodD = catmullRom2bezier(moodPts);
      const stressD = catmullRom2bezier(stressPts);
      const sleepD = catmullRom2bezier(sleepPts);

      // paths: stress (dashed), sleep (dotted), mood (solid prominent)
      svg += `<path d="${stressD}" fill="none" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--stress-color')}" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="6 4" />`;
      svg += `<path d="${sleepD}" fill="none" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--sleep-color')}" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="2 4" />`;
      svg += `<path d="${moodD}" fill="none" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--mood-color')}" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round" />`;

      // markers and invisible hover targets
      function addPoints(pts, color, idPrefix) {
        pts.forEach((p, i) => {
          // visible small marker
          svg += `<circle cx="${p.x}" cy="${p.y}" r="3.4" fill="${color}" stroke="rgba(0,0,0,0.18)" stroke-width="1"/>`;
          // invisible rect for easier hover (wider hit area)
          const hitW = Math.max(22, xStep);
          const hx = p.x - hitW/2;
          const hy = padding.t;
          svg += `<rect data-idx="${i}" data-series="${idPrefix}" x="${hx}" y="${hy}" width="${hitW}" height="${innerH}" fill="transparent" class="chart-hit" />`;
        });
      }
      addPoints(moodPts, getComputedStyle(document.documentElement).getPropertyValue('--mood-color'), 'mood');
      addPoints(stressPts, getComputedStyle(document.documentElement).getPropertyValue('--stress-color'), 'stress');
      addPoints(sleepPts, getComputedStyle(document.documentElement).getPropertyValue('--sleep-color'), 'sleep');

      // x labels (times) under points
      const labels = history.map(d => {
        const dt = new Date(d.t);
        const hh = String(dt.getHours()).padStart(2,'0');
        const mm = String(dt.getMinutes()).padStart(2,'0');
        return `${hh}:${mm}`;
      });
      labels.forEach((lab,i)=> {
        const lx = x(i);
        svg += `<text x="${lx}" y="${h - 4}" fill="${getComputedStyle(document.documentElement).getPropertyValue('--muted')}" font-size="11" text-anchor="middle">${lab}</text>`;
      });

      svg += `</svg>`;

      chartContainer.innerHTML = svg;

      // attach hover handlers to .chart-hit rectangles
      const svgEl = chartContainer.querySelector('svg');
      const hits = chartContainer.querySelectorAll('.chart-hit');
      hits.forEach(hit => {
        hit.addEventListener('mouseenter', (e) => {
          const series = hit.getAttribute('data-series');
          const idx = Number(hit.getAttribute('data-idx'));
          let pt, label, color;
          if (series === 'mood') { pt = moodPts[idx]; label = 'Mood'; color = getComputedStyle(document.documentElement).getPropertyValue('--mood-color'); }
          if (series === 'stress') { pt = stressPts[idx]; label = 'Stress'; color = getComputedStyle(document.documentElement).getPropertyValue('--stress-color'); }
          if (series === 'sleep') { pt = sleepPts[idx]; label = 'Sleep'; color = getComputedStyle(document.documentElement).getPropertyValue('--sleep-color'); }
          if (!pt) return;

          // tooltip content
          const dt = new Date(pt.t);
          const time = `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
          chartTooltip.innerHTML = `<strong style="color:${color}">${label}</strong>: ${pt.v} ‚Äî ${time}`;
          chartTooltip.style.display = 'block';

          // position tooltip near the point (convert SVG to container coords)
          const ptClient = svgEl.createSVGPoint();
          ptClient.x = pt.x; ptClient.y = pt.y;
          const ctm = svgEl.getScreenCTM();
          const screenPt = ptClient.matrixTransform(ctm);
          // place tooltip relative to chartContainer
          const rect = chartContainer.getBoundingClientRect();
          const left = screenPt.x - rect.left;
          const top = screenPt.y - rect.top;
          chartTooltip.style.left = `${left}px`;
          chartTooltip.style.top = `${top}px`;
        });

        hit.addEventListener('mouseleave', () => {
          chartTooltip.style.display = 'none';
        });
      });
    }

    // create record helper
    function createRecord(m,s,sl){ return { m:Number(m), s:Number(s), sl:Number(sl), t: Date.now() }; }

    // wire up events
    go.addEventListener('click', () => {
      const m = Number(mood.value), s = Number(stress.value), sl = Number(sleep.value);
      const decision = decideRecommendation(m,s,sl);
      renderRecommendation(decision, { m, s, sl });
      const newHist = pushRecord(createRecord(m,s,sl));
      renderChart(newHist);
    });

    sample.addEventListener('click', () => {
      const scenarios = [{m:0,s:10,sl:0},{m:2,s:8,sl:3},{m:5,s:4,sl:7},{m:8,s:3,sl:8},{m:6,s:5,sl:6}];
      const pick = scenarios[Math.floor(Math.random()*scenarios.length)];
      mood.value = pick.m; stress.value = pick.s; sleep.value = pick.sl; updateLabels();
      const decision = decideRecommendation(pick.m,pick.s,pick.sl);
      renderRecommendation(decision, { m: pick.m, s: pick.s, sl: pick.sl });
      const newHist = pushRecord(createRecord(pick.m,pick.s,pick.sl));
      renderChart(newHist);
    });

    reset.addEventListener('click', () => {
      mood.value = 0; stress.value = 0; sleep.value = 0; updateLabels();
      result.style.display = 'none'; result.innerHTML = '';
      if (safetyBox) safetyBox.classList.remove('show');
      if (consentBox) consentBox.classList.remove('show');
    });

    consentCheck.addEventListener('change', () => { consentProceed.disabled = !consentCheck.checked; });
    consentProceed.addEventListener('click', () => {
      const decision = decideRecommendation(Number(mood.value), Number(stress.value), Number(sleep.value));
      if (decision.primary === 'immediate_recovery') {
        const optional = window.APP_SUGGESTIONS.grounding_stress;
        if (!optional) return;
        const optionalHtml = `<div style="margin-top:12px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)"><strong style="display:block;margin-bottom:6px;color:var(--muted)">${optional.title} (optional)</strong><div style="color:var(--muted);font-size:13px">${optional.short || optional.description}</div><ul style="margin-top:8px;color:var(--muted)">${optional.steps.map(s => `<li>${s}</li>`).join('')}</ul></div>`;
        result.insertAdjacentHTML('beforeend', optionalHtml);
        consentBox.classList.remove('show');
      }
    });
    consentSkip.addEventListener('click', () => { consentBox.classList.remove('show'); });

    // init
    (function init(){
      const hist = loadHistory();
      renderChart(hist);
      mood.value = 0; stress.value = 0; sleep.value = 0; updateLabels();
      result.style.display = 'none';
      if (safetyBox) safetyBox.classList.remove('show');
      if (consentBox) consentBox.classList.remove('show');
    })();

    // responsive redraw
    window.addEventListener('resize', () => { renderChart(loadHistory()); });

    // accessibility: Enter triggers
    [mood,stress,sleep].forEach(s => s.addEventListener('keydown', (e) => { if (e.key === 'Enter') go.click(); }));
  </script>
</body>
</html>
